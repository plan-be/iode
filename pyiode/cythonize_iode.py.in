# Import needed modules
try:
    from setuptools import setup
    from setuptools import Extension
except ImportError:
    from distutils.core import setup
    from distutils.extension import Extension

from Cython.Build import cythonize

import numpy as np

# Visual Studio dir structure
build_dir          = '${CMAKE_BINARY_DIR}'
root_dir           = '${CMAKE_SOURCE_DIR}'

scr4_incl_dir      = '${CMAKE_SOURCE_DIR}/scr4'
iode_incl_dir      = '${CMAKE_SOURCE_DIR}/api'
iode_cpp_incl_dir  = '${CMAKE_SOURCE_DIR}/cpp_api'
boost_incl_dir     = '${Boost_INCLUDE_DIRS}'

scr4_lib_dir       = f'{build_dir}/scr4'
iode_lib_dir       = f'{build_dir}/api'
iode_cpp_lib_dir   = f'{build_dir}/cpp_api'

# see https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html

extensions = Extension('iode',
    include_dirs = [np.get_include(), boost_incl_dir, root_dir, scr4_incl_dir, iode_incl_dir, iode_cpp_incl_dir],
    library_dirs = [scr4_lib_dir, iode_lib_dir, iode_cpp_lib_dir],
    libraries = ['iode_scr4', 'iode_c_api', 'iode_cpp_api', 'odbc32', 'odbccp32', 'ws2_32', 'gdi32', 
                 'user32', 'advapi32', 'shell32', 'comdlg32', 'comctl32', 'Winspool', 'legacy_stdio_definitions'],
	extra_compile_args = [${IODE_CYTHON_FLAGS}],				
    sources = ["iode_python.pyx", "s_iode.c"],
    depends = [ "iode_python.pyx", "s_iode.c", 
                "pyiode_cdef.pyx", "pyiode_data.pyx", "pyiode_estim.pyx", 
                "pyiode_exec.pyx",  "pyiode_larray.pyx", "pyiode_lec.pyx",
                "pyiode_model.pyx", "objects/scalar.pyx", "objects/equation.pyx", 
                "pyiode_objs.pyx", "pyiode_print.pyx", "pyiode_reports.pyx", 
                "pyiode_period.pyx", "pyiode_sample.pyx", "pyiode_util.pyx", 
                "pyiode_ws.pyx"],
    define_macros=[("NPY_NO_DEPRECATED_API", "NPY_1_7_API_VERSION")]
)           

# cythonize arguments: https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#cythonize-arguments
# compiler_directives: https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives

setup(
    name = 'iode',
    ext_modules=cythonize(extensions, compiler_directives={"binding": True, "language_level": 3, "embedsignature": True, 
                            "embedsignature.format": "python"})
)
