# distutils: language = c++

from typing import List, Dict
import sys
if sys.version_info.minor >= 11:
    from enum import IntEnum, StrEnum
else:
    from enum import Enum, IntEnum
    StrEnum = Enum

from libcpp.string cimport string
from libcpp.vector cimport vector
from libcpp.map cimport map

from pyiode.common cimport IODE_NAN, IODE_NB_TYPES, EQS_NBTESTS
from pyiode.common cimport ESTIMATION_MAXIT as C_ESTIMATION_MAXIT 
from pyiode.common cimport ESTIMATION_EPS as C_ESTIMATION_EPS
from pyiode.common cimport (IodeDatabaseType, EnumIodeFile, EnumLang, EnumIodeEquationMethod, 
                            EnumIodeEquationTest, EnumIodeLtoH, EnumIodeHtoL, 
                            EnumCellType, EnumCellAlign, EnumCellFont, EnumLineType, 
                            EnumGraphAlign, EnumGraphAxis, EnumGraphGrid, EnumGraphType, 
                            EnumIodeVarMode, VariablesInitialization, 
                            EnumSimulationSortAlgorithm, EnumIodeAdjustmentMethod)
from pyiode.common cimport (vIodeTypes, v_ext_names, vLangs, v_eq_methods, v_var_modes, 
                            v_simulation_initialization, v_simulation_sort_algorithm, 
                            v_adjustment_method, mLowToHigh)

try:
    import pandas as pd
    Series = pd.Series
    DataFrame = pd.DataFrame
except ImportError:
    pd = None
    Series = Any
    DataFrame = Any

try:
    import larray as la
    Array = la.Array
    Axis = la.Axis
except ImportError:
    la = None
    Array = Any
    Axis = Any


# The function below exists because Cython seems to refuse to iterate over 
# a const std container except in a function or method
def _cpp_string_vector_to_py(vector[string] vec) -> List[str]:
    return [value.decode() for value in vec]

# The function below exists because Cython seems to refuse to iterate over 
# a const std container except in a function or method
def _cpp_char_string_map_to_py(map[char, string] c_map) ->Dict[str, str]:
    return {chr(item.first): item.second.decode() for item in c_map}


# VERSION
# -------
__version__ = "${CMAKE_PROJECT_VERSION}"


# IODE CONSTANTS
# --------------
NA: float = IODE_NAN


# IODE ENUMS
# ----------

class IodeTypes(IntEnum):
    COMMENTS = IodeDatabaseType.COMMENTS
    EQUATIONS = IodeDatabaseType.EQUATIONS
    IDENTITIES = IodeDatabaseType.IDENTITIES
    LISTS = IodeDatabaseType.LISTS
    SCALARS = IodeDatabaseType.SCALARS
    TABLES = IodeDatabaseType.TABLES
    VARIABLES = IodeDatabaseType.VARIABLES

class IodeFileExt(IntEnum):
    COMMENTS = EnumIodeFile.COMMENTS_FILE
    EQUATIONS = EnumIodeFile.EQUATIONS_FILE
    IDENTITIES = EnumIodeFile.IDENTITIES_FILE
    LISTS = EnumIodeFile.LISTS_FILE
    SCALARS = EnumIodeFile.SCALARS_FILE
    TABLES = EnumIodeFile.TABLES_FILE
    VARIABLES = EnumIodeFile.VARIABLES_FILE
    REPORTS = EnumIodeFile.I_REPORTS_FILE
    TEXT = EnumIodeFile.I_TEXT_FILE
    ASCII = EnumIodeFile.I_ASCII_FILE
    A2M = EnumIodeFile.I_A2M_FILE
    RTF = EnumIodeFile.I_RTF_FILE
    HTML = EnumIodeFile.I_HTML_FILE
    MIF = EnumIodeFile.I_MIF_FILE
    CSV = EnumIodeFile.I_CSV_FILE
    REF = EnumIodeFile.I_REF_FILE
    AGL = EnumIodeFile.I_AGL_FILE
    DIF = EnumIodeFile.I_DIF_FILE
    LOGS = EnumIodeFile.I_LOGS_FILE
    SETTINGS = EnumIodeFile.I_SETTINGS_FILE
    ANY = EnumIodeFile.I_ANY_FILE
    DIRECTORY = EnumIodeFile.I_DIRECTORY

class IodeLanguage(IntEnum):
    ENGLISH = EnumLang.IT_ENGLISH
    DUTCH = EnumLang.IT_DUTCH
    FRENCH = EnumLang.IT_FRENCH

class EqMethod(IntEnum):
    LSQ = 0
    ZELLNER = 1
    INSTRUMENTAL = 2
    GLS = 3
    MAX_LIKELIHOOD = 4

class EqTest(IntEnum):
    CORR = EnumIodeEquationTest.IE_CORR
    STDEV = EnumIodeEquationTest.IE_STDEV
    MEANY = EnumIodeEquationTest.IE_MEANY
    SSRES = EnumIodeEquationTest.IE_SSRES
    STDERR = EnumIodeEquationTest.IE_STDERR
    STDERRP = EnumIodeEquationTest.IE_STDERRP
    FSTAT = EnumIodeEquationTest.IE_FSTAT
    R2 = EnumIodeEquationTest.IE_R2
    R2ADJ = EnumIodeEquationTest.IE_R2ADJ
    DW = EnumIodeEquationTest.IE_DW
    LOGLIK = EnumIodeEquationTest.IE_LOGLIK

EQ_TEST_NAMES: Tuple[str, ...] = tuple(member.name.lower() for member in EqTest)

class TableCellType(IntEnum):
    LEC = EnumCellType.IT_LEC
    STRING = EnumCellType.IT_STRING

class TableCellFont(IntEnum):
    NORMAL = EnumCellFont.IT_NORMAL
    BOLD = EnumCellFont.IT_BOLD
    ITALIC = EnumCellFont.IT_ITALIC
    UNDERLINE = EnumCellFont.IT_UNDERLINE

class TableCellAlign(IntEnum):
    CENTER = EnumCellAlign.IT_CENTER
    LEFT = EnumCellAlign.IT_LEFT
    RIGHT = EnumCellAlign.IT_RIGHT
    DECIMAL = EnumCellAlign.IT_DECIMAL

class TableLineType(IntEnum):
    FILES = EnumLineType.IT_FILES
    MODE = EnumLineType.IT_MODE
    CELL = EnumLineType.IT_CELL
    LINE = EnumLineType.IT_LINE
    TITLE = EnumLineType.IT_TITLE
    DATE = EnumLineType.IT_DATE

class TableLineGraph(IntEnum):
    LINE = EnumGraphType.IG_LINE
    SCATTER = EnumGraphType.IG_SCATTER
    BAR = EnumGraphType.IG_BAR

class TableGraphGrid(IntEnum):
    MAJOR = EnumGraphGrid.IG_MAJOR
    NONE = EnumGraphGrid.IG_NONE
    MINOR = EnumGraphGrid.IG_MINOR

class TableGraphAlign(IntEnum):
    LEFT = EnumGraphAlign.IG_LEFT
    CENTER = EnumGraphAlign.IG_CENTER
    RIGHT = EnumGraphAlign.IG_RIGHT

class TableGraphAxis(IntEnum):
    VALUES = EnumGraphAxis.IG_VALUES
    LOG = EnumGraphAxis.IG_LOG
    SEMILOG = EnumGraphAxis.IG_SEMILOG
    PERCENT = EnumGraphAxis.IG_PERCENT

class VarsMode(IntEnum):
    LEVEL = EnumIodeVarMode.I_VAR_MODE_LEVEL
    DIFF = EnumIodeVarMode.I_VAR_MODE_DIFF
    GROWTH_RATE = EnumIodeVarMode.I_VAR_MODE_GROWTH_RATE
    Y0Y_DIFF = EnumIodeVarMode.I_VAR_MODE_Y0Y_DIFF
    Y0Y_GROWTH_RATE = EnumIodeVarMode.I_VAR_MODE_Y0Y_GROWTH_RATE

class LowToHighType(IntEnum):
    STOCK = EnumIodeLtoH.LTOH_STOCK
    FLOW = EnumIodeLtoH.LTOH_FLOW

class LowToHighMethod(StrEnum):
    LINEAR = 'L'
    CUBIC_SPLINES = 'C'
    STEP = 'S'

class HighToLowType(IntEnum):
    LAST = EnumIodeHtoL.HTOL_LAST
    MEAN = EnumIodeHtoL.HTOL_MEAN
    SUM = EnumIodeHtoL.HTOL_SUM

class SimulationSort(IntEnum):
    CONNEX = EnumSimulationSortAlgorithm.I_SORT_CONNEX
    BOTH = EnumSimulationSortAlgorithm.I_SORT_BOTH
    NONE = EnumSimulationSortAlgorithm.I_SORT_NONE

class SimulationInitialization(IntEnum):
    TM1 = VariablesInitialization.VAR_INIT_TM1
    TM1_A = VariablesInitialization.VAR_INIT_TM1_A
    EXTRA = VariablesInitialization.VAR_INIT_EXTRA
    EXTRA_A = VariablesInitialization.VAR_INIT_EXTRA_A
    ASIS = VariablesInitialization.VAR_INIT_ASIS
    TM1_NA = VariablesInitialization.VAR_INIT_TM1_NA
    EXTRA_NA = VariablesInitialization.VAR_INIT_EXTRA_NA

ESTIMATION_MAXIT = C_ESTIMATION_MAXIT 
ESTIMATION_EPS: float = C_ESTIMATION_EPS

class AdjustmentMethod(IntEnum):
    PARTIAL = EnumIodeAdjustmentMethod.AM_PARTIAL_ADJUSTMENT
    ERROR_CORRECTION = EnumIodeAdjustmentMethod.AM_ERROR_CORRECTION_METHOD

class WriteFileExt(IntEnum):
    GDI = 1
    A2M = 7
    MIF = 6
    HTML = 5
    RTF = 4
    CSV = 8
    DUMMY = 9
